---
title: "Stats 506 (F20) Group Project"
author: 'Group 6: Erin Cikanek, Suppapat Korsurat, Kyle William Schulz'
date: "`r format.Date(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    theme: paper
    toc: yes
  pdf_document:
    toc: yes
---

```{r, include = FALSE, echo = FALSE, warning = FALSE}
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(knitr)
library(foreign)
```

## GROUP TO DO LIST 
1. Match up language within code between group members how-tos 
2. Summary/Discussion/Reference sections 
3. Match up plotting style as much as possible 
4. Organize git repo
5. Update readme 
6. Improve readme style/info 

### Introduction
Linear regression has become widely known as a backbone of modern statistics. Even as more complex, "black box"-style machine learning techniques increase in popularity, many statisticians and researchers still fall back on regression for its interpretability and simpleness. However, linear regression relies on a number on assumptions that may not always be true in practice, such as the constant, monotonic linearity of predictor variables in relation to the response. In this guide, we explore the use of splines to help model predictor variables that may have changing relationships across their domain. These techniques help us to match the predictive power seen in some more advanced machine learning algorithms while keeping the benefits gained by using regression. We show examples in three popular statistical modelling languages - python, R, and STATA. 

### Data
In this guide, we will be using the "wage" dataset from the R package ISLR. This data is also used in the book [Introduction to Statistical Learning](http://faculty.marshall.usc.edu/gareth-james/ISL/). This dataset contains wages from 3,000 Mid-Atlantic, male workers, between the years 2003-2009, along with a select number of other personal demographics. We retain the variables for `wage`, `age`, `year`, and `education` for our analysis. Our goal is to examine the relationship between age, year, and education and workers' yearly wage. 

### Method
We will first calculate a simple linear regression as a baseline. We will then implement four different spline-like techniques on the "age" predictor variable: a step function, polynomial regression, basis spline, and natural spline. At each step, we will check for fit quality, noting any potential improvements along the way. We will conclude with a retrospective and summary of what we learned.   

### Core Analysis {.tabset}
#### Python
```{r, eval = FALSE}
#!/usr/bin/env python
# coding: utf-8

# In[1]:


#Packages required 
import pandas as pd
import matplotlib.pyplot as plt
plt.style.use('fivethirtyeight')
#%matplotlib inline
import statsmodels.api as sm
import numpy as np
from sklearn.preprocessing import PolynomialFeatures
from patsy import dmatrix


# In[2]:


#Let's read in the data file 
data = pd.read_csv("/Users/kwschulz/STATS506/Stats506_Project/Dataset/data.csv")


# In[3]:


#Take a quick glance at what the data looks like
data.head()


# In[4]:


#Let's check to see if we have any missing values
data.isna().sum()


# In[5]:


#Filter to variables for our analysis 
data = data[["wage", "age", "education", "year"]]


# In[6]:


#Map education to ordinal scale
education_map = {"1. < HS Grad":1,"2. HS Grad":2,
                "3. Some College":3, "4. College Grad":4,
                "5. Advanced Degree":5}
data['education'] = data.education.map(education_map)


# In[7]:


#Lets check the distribution of our predictors
data[["wage", "age"]].hist(layout=(2,1), figsize=(15,15))
plt.show()
plt.savefig('hist.png')


# In[8]:


#checking year distribution
data.year.value_counts().reindex([2003, 2004, 2005, 2006, 2007, 2008, 2009]).plot(kind='bar', 
                                                                                  title='year', 
                                                                                  ylabel='count', 
                                                                                  figsize=(7.5,7.5))
plt.savefig('year_bar.png')


# In[9]:


#checking education distribution 
data.education.value_counts().reindex([1, 2, 3, 4, 5]).plot(kind='bar', 
                                                            title='education', 
                                                            ylabel='count', 
                                                            figsize=(7.5,7.5))
plt.savefig('education_bar.png')


# In[10]:


#linear regression model
model = sm.OLS(data["wage"], sm.add_constant(data.drop('wage',axis=1))).fit()


# In[11]:


#let's check how it did
model.summary()


# In[12]:


#let's cut age into 6 bins - stepwise
data["age_cut"] = pd.cut(data.age, bins=6, labels=False)


# In[13]:


#now let's model age with bins 
model2 = sm.OLS(data["wage"], sm.add_constant(data.drop(['wage','age'],axis=1))).fit()


# In[14]:


#model 2 summary
model2.summary()


# In[15]:


#let's check out the scatter plot of age v wage 
data.plot(x="age", y="wage", kind='scatter', figsize=(7.5,7.5))


# In[16]:


#2nd degree polynomial 
p = np.poly1d(np.polyfit(data["age"], data["wage"], 2))
t = np.linspace(0, 80, 200)
plt.plot(data["age"], data["wage"], 'o', t, p(t), '-')
rs = sm.OLS(data["wage"], 
            np.column_stack([data["age"]**i for i in range(2)]) ).fit().rsquared
plt.title('r2 = {}'.format(rs))
plt.show()
plt.savefig('poly2.png')


# In[17]:


#3rd degree polynomial 
p = np.poly1d(np.polyfit(data["age"], data["wage"], 3))
t = np.linspace(0, 80, 200)
plt.plot(data["age"], data["wage"], 'o', t, p(t), '-')
rs = sm.OLS(data["wage"], 
            np.column_stack([data["age"]**i for i in range(3)]) ).fit().rsquared
plt.title('r2 = {}'.format(rs))
plt.show()
plt.savefig('poly3.png')


# In[18]:


#4th degree polynomial
p = np.poly1d(np.polyfit(data["age"], data["wage"], 4))
t = np.linspace(0, 80, 200)
plt.plot(data["age"], data["wage"], 'o', t, p(t), '-')
rs = sm.OLS(data["wage"], 
            np.column_stack([data["age"]**i for i in range(4)]) ).fit().rsquared
plt.title('r2 = {}'.format(rs))
plt.show()
plt.savefig('poly4.png')


# In[19]:


#5th degree polynomial
p = np.poly1d(np.polyfit(data["age"], data["wage"], 5))
t = np.linspace(0, 80, 200)
plt.plot(data["age"], data["wage"], 'o', t, p(t), '-')
rs = sm.OLS(data["wage"], 
            np.column_stack([data["age"]**i for i in range(5)]) ).fit().rsquared
plt.title('r2 = {}'.format(rs))
plt.show()
plt.savefig('poly5.png')


# In[20]:


#let's do a third polynomial regression 
polynomial_features= PolynomialFeatures(degree=3)
age_p = polynomial_features.fit_transform(data['age'].to_numpy().reshape(-1, 1))
model3 = sm.OLS(data["wage"], sm.add_constant(np.concatenate([data[['education', 'year']].to_numpy(), age_p], axis=1))).fit() 


# In[21]:


#check our results
model3.summary(xname=['education', 'year', 'const', 'poly(age, 3)1', 'poly(age, 3)2', 'poly(age, 3)3'])


# In[22]:


#implementing a bspline for age 
age_bs = dmatrix("bs(data.age, df=6)",{"data.age": data.age}, return_type='dataframe')
model4 = sm.OLS(data["wage"], pd.concat([age_bs, data[['education', 'year']]], axis=1)).fit() 
model4.summary()


# In[23]:


#implementing a natural spline for age 
age_ns = dmatrix("cr(data.age, df=6)",{"data.age": data.age}, return_type='dataframe')
model5 = sm.OLS(data["wage"], pd.concat([age_ns, data[['education', 'year']]], axis=1)).fit() 
model5.summary()


```

```{r, eval = FALSE}
"When you want to show only code, but prevent this chunck to run."
```

```{r, echo = FALSE}
print("When you want this chunck to run, but don't want to show the code.")
```

#### Stata
Before starting analysis using splines, first look at OLS regression with wage as it relates to age, year, and education. We can run the simple code below to look at this relationship.
```{r, eval = FALSE}
reg wage age year edu
```

Stata will return the following output:

![OLS output for wage ~ age + year + education](/Users/erincikanek/GitHub/Stats506_Project/Stata/stata_reg_output.png)



To see if a non-linear relationship might be present, kernal density, pnorm, and qnorm plots can assit with this: 
```{r, eval = FALSE}
predict r, resid
kdensity r, normal
```

![Kernal Density Plot](/Users/erincikanek/GitHub/Stats506_Project/Stata/kernel_dens_reg.jpg)

![Pnorm Plot](/Users/erincikanek/GitHub/Stats506_Project/Stata/pnorm_reg.jpg)
![QNorm Plot](/Users/erincikanek/GitHub/Stats506_Project/Stata/qnorm_reg.jpg)
After looking at these plots we might consider the different relationships that age may have with wage. We can plot the two-way fit between wage and age, our main variables of interest, to compare a basic linear, polynomial, and quadratic fit.   

```{r, eval = FALSE}
twoway (scatter wage age) (lfit wage age) (fpfit wage age) (qfit wage age)
```


![Fitted Plot - Linear (red), polynomial (green), and quadratic (yellow) fit](/Users/erincikanek/GitHub/Stats506_Project/Stata/scatter_fit_plots.jpg)

Based on these plots we might be interested in trying to fit a cubic polynomial plot next. 



##### Cubic Polynomial

To create a cubic polynomial in stata we can use the `##` command with the `age` variable. The regression is written as before with the addition of a cubic fit:

```{r, eval = FALSE}
reg wage c.age##c.age##c.age year educ
```

The output in Stat will look like this: 

![Regression with Cubic polynomial for Age](/Users/erincikanek/GitHub/Stats506_Project/Stata/cubic_polynom.png)


##### Piecewise Step Function Regression

For the piecewise step function, the steps and intercepts in Stata must be determined manually. Based on analysis in `R` we determined that including 6 groups with 5 cutpoints is best. The below code shows how to generate six age categories and their intercepts. 

```{r, eval = FALSE}
* generate 6 age variables, one for each bin * 
* the age varaible does not have decimels * 

generate age1 = (age - 28.33)
replace age1 = 0 if (age >= 28.33)
generate age2 = (age-38.66)
replace age2 = 0 if age <28.33 | age > 38.66
generate age3 = (age- 48.99)
replace age3 = 0 if age <38.66 | age >=48.99
generate age4 = (age - 59.33)
replace age4 = 0 if age <48.99 | age >= 59.33 
generate age5 = (age - 69.66)
replace age5= 0 if age < 59.33 | age>=69.66
generate age6 = (age-80)
replace age6 = 0 if age <69.66

* create intercept variables* 


generate int1 = 1
replace int1 = 0 if age >= 28.33
generate int2 = 1
replace int2 = 0 if age <28.33 | age > 38.66
generate int3 = 1
replace int3 = 0 if age <38.66 | age >=48.99
generate int4 = 1
replace int4 = 0 if age <48.99 | age >= 59.33 
generate int5 = 1
replace int5= 0 if age < 59.33 | age>=69.66
generate int6 = 1
replace int6 = 0 if age <69.66

```

Using these variables we can then compute a step-wise regression. 


```{r, eval = FALSE}
regress wage int1 int2 int3 int4 int5 int6 age1 age2 age3 age4 age5 age6 ///
	year educ, hascons
```


![Step-wise regression for Age with 6 bins](/Users/erincikanek/GitHub/Stats506_Project/Stata/step_wise.png)



After running the regression we can then use the predicted yhats to graph the results: 

```{r, eval = FALSE}
predict yhat

twoway (scatter wage age, sort) ///
         (line yhat age if age <28.33, sort) ///
		 (line yhat age if age >=28.33 & age < 38.66, sort) ///
		 (line yhat age if age >=38.66 & age < 48.99, sort) ///
		 (line yhat age if age >=48.99 & age<59.33, sort) ///
		 (line yhat age if age >=59.33 & age<69.66, sort) ///
		 (line yhat age if age >=69.66, sort), xline(28.33 38.66 48.99 59.33 69.66) // this looks awful

```



![Step-wise regression for Age with 6 bins](/Users/erincikanek/GitHub/Stats506_Project/Stata/Step_function.jpg)


##### Basis Spline
For the basis spline, we use the command `bspline`, created by Roger Newson and suggested by [Germán Rodríguez at Princeton] (https://data.princeton.edu/eco572/smoothing2). To create the spline, we call `bspline`, setting the x variable to age and then identifying where we would like the knots in the function. For this example I use 3 knots at 35, 50 and 65, however it should be noted that the min and max of the values need to be included in the knots parentheses. I also use a cubic spline, incidated by `p(3)`. The last step in the line of code is the code that generates the splines for inclusions in the regression. Then the regression can be written as below.    


```{r, eval = FALSE}
bspline, xvar(age) knots(18 35 50 65 80) p(3) gen(_agespt)


regress wage _agespt* year educ, noconstant

```


The output for the regression in Stata is: 


![Basis Spline Regression](/Users/erincikanek/GitHub/Stats506_Project/Stata/spline_reg.png)


To look at the fit for age, we can examine the two-way scatter plot between `wage` and `age` using the predicted values of the bivariate regression with splines. 
```{r, eval = FALSE}
regress wage _agespt*, noconstant
predict agespt
*(option xb assumed; fitted values)


twoway (scatter wage age)(line agespt age, sort), legend(off)  ///
           title(Basis Spline for Age)

```



![Step-wise regression for Age with 6 bins](/Users/erincikanek/GitHub/Stats506_Project/Stata/basis_spline.jpg)




##### Natural Spline
This further extension is still being coded. Please see the README.md file. 





#### R
The library `splines` is required for implementing splines by using R.
```{r}
library(splines)
```

```{r, include = FALSE}
data <- read.csv("~/GitHub/Stats506_Project/Dataset/data.csv")
```

```{r scatter_wage_age, include = FALSE}
wage_age <- function(line = FALSE, poly = 1, formula_wage_age = y ~ x){
  plot_title <- "Scatter Plot between Wage and Age"
  
  if(poly != 1){
    plot_title <- paste0("Polynomial degree ", poly)
  }
  
  plot_wage_age <- ggplot(data, aes(x = age, y = wage)) + 
    geom_point(color = "darkblue") +
    theme_bw() +
    labs(title = plot_title, x = "Age", y = "Wage")
  
  if(line == TRUE){
    plot_wage_age + 
      geom_smooth(method = "lm", formula = formula_wage_age, color = "yellow")
  } else {
    plot_wage_age
  }
}
```

First, considering the linear regression.
```{r}
model <- lm(wage ~ age + education + year, data = data)
summary(model)
```

The $R^2$ is 0.2619, which is pretty low. Consider the scatter plot between 
`Wage` and `Age`.

```{r, echo = FALSE, fig.cap = fig_s1}
wage_age()
fig_s1 <- paste0("Figure 3.1 Scatter plot between Wage and Age")
```

The scatter plot show that the relationship between these two variables are not linear. Hence, we will try various types of spline.

##### Step Function
Consider applying the step function on `Age`. 
```{r}
model_cut <- lm(wage ~ cut(age, 4) + education + year, data = data)
summary(model_cut)
```

The $R^2$ is 0.2828, which improved from the previous model. The plot below 
is a scatterplot between `Wage` and `Age`, also the yellow line represents 
the step function.

```{r, echo = FALSE, fig.cap = fig_s2}
wage_age(TRUE, 1, y ~ cut(x,4))
fig_s2 <- paste0("Figure 3.2 Scatter plot between Wage and Age with the
                 step function.")
```

##### Polynomial Regression
Consider the various number for the degree in the polynomial regression. The plots below are the result from the fitting polynomial regression.
```{r, echo = FALSE, warning = FALSE}
degree_poly <- c(2,3,5,20)

for(i in 1:length(degree_poly)){
  poly_d <- degree_poly[i]
  print(wage_age(TRUE, poly_d, y ~ poly(x, poly_d)))
}

```

```{r, echo = FALSE}
poly_r2 <- c()

for(i in 2:20){
  r2_p <-summary(lm(wage ~ poly(age, i) + education + year, 
                   data = data))$r.squared
  poly_r2 <- c(poly_r2, r2_p)
}

poly_r2 <- data.frame(degree = 2:20, R2 = poly_r2)
colnames(poly_r2) <- c("Degree of the age polynomial", "R-Squared")
poly_r2
```

Even the higher degree give the higher $R^2$, the `overfitting` problem may be occured. Hence, polynomial regression with degree 3 would be appropriate.

```{r}
model_poly <- lm(wage ~ poly(age, 3) + education + year, data = data)
summary(model_poly)
```

The $R^2$ is 0.2909, which improved from all previous models.

##### Basis Spline and Natural Spline
For both `Basis Spline` and `Natural Spline`, the number of knots or the degree of freedom need to be specified. One of the method used for specified is performing `K-fold Cross Validation`. In this case, K is equal to 5. For both types of spline, the highest degree of polynomial for age is 3.

  - Basis Spline: df = 4 + knots
  - Natural Spline: df = 2 + knots

```{r k_fold_cv, include = FALSE}
set.seed(1)
data$CV <- sample(rep(1:5, 600))
```

```{r k_fold_plot, include = FALSE}
## Function for calculate and plot
plot_kfold <- function(knots = 1:10, bs = TRUE){
  store_MSE <- c()
  title_plot <- "5-fold cross-validate MSE"
  
  if(bs == TRUE){
    title_plot <- paste0(title_plot, ": Basis Spline")
  } else  {
    title_plot <- paste0(title_plot, ": Natural Spline")
  }
  
  for(i in knots){
    
    MSE <- c()
    
    for(j in 1:5){
      
      ## Split the data
      train_data <- data %>% filter(CV != j)
      validate_data <- data %>% filter(CV == j)
      
      ## Train the model
      if(bs == TRUE){
        model <- lm(wage ~ bs(age, df = 4 + i) + education + year, 
                    data = train_data)
      } else {
        model <- lm(wage ~ ns(age, df = 2 + i) + education + year, 
                    data = train_data)
      }
      
      ## Store the MSE for each validation set
      MSE <- c(MSE, 
               mean((predict(model, validate_data) - validate_data$wage)^2))
      
    }
    
    ## Store the MSE for each knots
    store_MSE <- c(store_MSE, mean(MSE))
  }
  
  ## Create a plot
  dummy_result <- data.frame(knots = as.factor(knots), store_MSE)
  p <- ggplot(dummy_result, aes(x = knots, y = store_MSE, group = 1)) +
    geom_line() +
    geom_point() +
    labs(title = title_plot, x = "Number of knot", y = "MSE") +
    geom_text(aes(label = round(store_MSE,2)), vjust = -1) +
    ylim(min(store_MSE) - 3, max(store_MSE) + 3) +
    theme_bw()
  print(p)
}
```

Consider the MSE for basis spline.

```{r, echo = FALSE}
plot_kfold()
```

The MSE is lowest when the number of `knot` is equal to 2. Fit the regression with basis spline.

```{r}
model_basis <- lm(wage ~ bs(age, df = 6) + education + year, data = data)
summary(model_basis)
```

The $R^2$ is 0.2923.

Then consider the Natural Spline.

```{r, echo = FALSE}
plot_kfold(bs = FALSE)
```

The MSE is lowest when the number of `knot` is equal to 4. Fit the regression with natural spline.

```{r}
model_natural <- lm(wage ~ ns(age, df = 6) + education + year, data = data)
summary(model_natural)
```

The $R^2$ is 0.2927.

### Summary
### Discussion
### Reference


