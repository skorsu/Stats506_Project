---
title: "Stats 506, F20, Group Project"
author: "Group 6: Erin Susan Cikanek, Suppapat Korsurat, Kyle William Schulz"
date: "`r format.Date(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    theme: paper
    df_print: paged
    toc: TRUE
---

```{r, include = FALSE, echo = FALSE, warning = FALSE}
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(knitr)
```

### Introduction

### Data 

### Method

### Core Analysis {.tabset}
#### Python
```{r, eval = FALSE}
"Kyle's Code"
```

```{r, eval = FALSE}
"When you want to show only code, but prevent this chunck to run."
```

```{r, echo = FALSE}
print("When you want this chunck to run, but don't want to show the code.")
```

#### Stata
```{r, eval = FALSE}
"Erin's Code"
```

```{r, eval = FALSE}
"When you want to show only code, but prevent this chunck to run."
```

```{r, echo = FALSE}
print("When you want this chunck to run, but don't want to show the code.")
```

#### R
The library `splines` is required for implementing splines by using R.
```{r}
library(splines)
```

```{r, include = FALSE}
data <- read.csv("/Users/kevin/506FA20/Stats506_Project/Dataset/data.csv")
```

```{r scatter_wage_age, include = FALSE}
wage_age <- function(line = FALSE, poly = 1, formula_wage_age = y ~ x){
  plot_title <- "Scatter Plot between Wage and Age"
  
  if(poly != 1){
    plot_title <- paste0("Polynomial degree ", poly)
  }
  
  plot_wage_age <- ggplot(data, aes(x = age, y = wage)) + 
    geom_point(color = "darkblue") +
    theme_bw() +
    labs(title = plot_title, x = "Age", y = "Wage")
  
  if(line == TRUE){
    plot_wage_age + 
      geom_smooth(method = "lm", formula = formula_wage_age, color = "yellow")
  } else {
    plot_wage_age
  }
}
```

First, considering the linear regression.
```{r}
model <- lm(wage ~ age + education + year, data = data)
summary(model)
```

The $R^2$ is 0.2619, which is pretty low. Consider the scatter plot between 
`Wage` and `Age`.

```{r, echo = FALSE, fig.cap = fig_s1}
wage_age()
fig_s1 <- paste0("Figure 3.1 Scatter plot between Wage and Age")
```

The scatter plot show that the relationship between these two variables are not linear. Hence, we will try various types of spline.

##### Step Function
Consider applying the step function on `Age`. 
```{r}
model_cut <- lm(wage ~ cut(age, 4) + education + year, data = data)
summary(model_cut)
```

The $R^2$ is 0.2828, which improved from the previous model. The plot below 
is a scatterplot between `Wage` and `Age`, also the yellow line represents 
the step function.

```{r, echo = FALSE, fig.cap = fig_s2}
wage_age(TRUE, 1, y ~ cut(x,4))
fig_s2 <- paste0("Figure 3.2 Scatter plot between Wage and Age with the
                 step function.")
```

##### Polynomial Regression
Consider the various number for the degree in the polynomial regression. The plots below are the result from the fitting polynomial regression.
```{r, echo = FALSE, warning = FALSE}
degree_poly <- c(2,3,5,20)

for(i in 1:length(degree_poly)){
  poly_d <- degree_poly[i]
  print(wage_age(TRUE, poly_d, y ~ poly(x, poly_d)))
}

```

```{r, echo = FALSE}
poly_r2 <- c()

for(i in 2:20){
  r2_p <-summary(lm(wage ~ poly(age, i) + education + year, 
                   data = data))$r.squared
  poly_r2 <- c(poly_r2, r2_p)
}

poly_r2 <- data.frame(degree = 2:20, R2 = poly_r2)
colnames(poly_r2) <- c("Degree of the age polynomial", "R-Squared")
poly_r2
```

Even the higher degree give the higher $R^2$, the `overfitting` problem may be occured. Hence, polynomial regression with degree 3 would be appropriate.

```{r}
model_poly <- lm(wage ~ poly(age, 3) + education + year, data = data)
summary(model_poly)
```

The $R^2$ is 0.2909, which improved from all previous models.

##### Basis Spline and Natural Spline
For both `Basis Spline` and `Natural Spline`, the number of knots or the degree of freedom need to be specified. One of the method used for specified is performing `K-fold Cross Validation`. In this case, K is equal to 5. For both types of spline, the highest degree of polynomial for age is 3.

  - Basis Spline: df = 4 + knots
  - Natural Spline: df = 2 + knots

```{r k_fold_cv, include = FALSE}
set.seed(1)
data$CV <- sample(rep(1:5, 600))
```

```{r k_fold_plot, include = FALSE}
## Function for calculate and plot
plot_kfold <- function(knots = 1:10, bs = TRUE){
  store_MSE <- c()
  title_plot <- "5-fold cross-validate MSE"
  
  if(bs == TRUE){
    title_plot <- paste0(title_plot, ": Basis Spline")
  } else  {
    title_plot <- paste0(title_plot, ": Natural Spline")
  }
  
  for(i in knots){
    
    MSE <- c()
    
    for(j in 1:5){
      
      ## Split the data
      train_data <- data %>% filter(CV != j)
      validate_data <- data %>% filter(CV == j)
      
      ## Train the model
      if(bs == TRUE){
        model <- lm(wage ~ bs(age, df = 4 + i) + education + year, 
                    data = train_data)
      } else {
        model <- lm(wage ~ ns(age, df = 2 + i) + education + year, 
                    data = train_data)
      }
      
      ## Store the MSE for each validation set
      MSE <- c(MSE, 
               mean((predict(model, validate_data) - validate_data$wage)^2))
      
    }
    
    ## Store the MSE for each knots
    store_MSE <- c(store_MSE, mean(MSE))
  }
  
  ## Create a plot
  dummy_result <- data.frame(knots = as.factor(knots), store_MSE)
  p <- ggplot(dummy_result, aes(x = knots, y = store_MSE, group = 1)) +
    geom_line() +
    geom_point() +
    labs(title = title_plot, x = "Number of knot", y = "MSE") +
    geom_text(aes(label = round(store_MSE,2)), vjust = -1) +
    ylim(min(store_MSE) - 3, max(store_MSE) + 3) +
    theme_bw()
  print(p)
}
```

Consider the MSE for basis spline.

```{r, echo = FALSE}
plot_kfold()
```

The MSE is lowest when the number of `knot` is equal to 2. Fit the regression with basis spline.

```{r}
model_basis <- lm(wage ~ bs(age, df = 6) + education + year, data = data)
summary(model_basis)
```

The $R^2$ is 0.2923.

Then consider the Natural Spline.

```{r, echo = FALSE}
plot_kfold(bs = FALSE)
```

The MSE is lowest when the number of `knot` is equal to 4. Fit the regression with natural spline.

```{r}
model_natural <- lm(wage ~ ns(age, df = 6) + education + year, data = data)
summary(model_natural)
```

The $R^2$ is 0.2927.

### Summary
### Discussion
### Reference


